<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Set Your PIN - NovaHunt.ai</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
body{font-family:Inter,system-ui,sans-serif;background:#f9fafb;color:#111827;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
.container{width:90%;max-width:500px;background:white;padding:40px;border-radius:24px;box-shadow:0 14px 40px rgba(2,6,23,.06);text-align:center}
h1{font-size:36px;font-weight:800;margin-bottom:16px}
p{font-size:18px;color:#4b5563;margin-bottom:32px}
.form-group{margin-bottom:16px}
input{width:100%;padding:16px;border:2px solid #d1d5db;border-radius:12px;font-size:16px}
.cta{width:100%;padding:16px;font-size:18px;font-weight:800;background:linear-gradient(180deg,#007bff,#06f);color:white;border:none;border-radius:16px;cursor:pointer;box-shadow:0 20px 40px rgba(0,102,255,.2)}
.message{margin-top:16px;font-size:16px;min-height:24px}
.progress-bar{width:100%;background:#e5e7eb;border-radius:8px;overflow:hidden;margin-top:16px;height:8px;display:none}
.progress-fill{height:100%;background:#007bff;width:0%;transition:width .5s}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
  <h1>Payment Successful! ðŸŽ‰</h1>
  <p>Enter the email you used for payment and set your PIN to unlock your plan.</p>

  <div class="form-group">
    <input type="email" placeholder="Email used for payment" id="email" required>
  </div>

  <div class="form-group">
    <input type="password" placeholder="Create PIN (6+ characters)" id="pin" minlength="6" required>
  </div>

  <button type="button" class="cta" id="submit">Set PIN & Go to Account</button>

  <p class="message" id="message"></p>
  <div class="progress-bar" id="progress"><div class="progress-fill" id="fill"></div></div>
</div>

<script>
// Check if supabase is already defined
if (!window.supabase) {
  console.log('Initializing Supabase client...');
  window.supabase = Supabase.createClient(
    'https://zusfblqrhqalgywcdvld.supabase.co',
    'sb_publishable_KVGRBPQZKqrhQomdahPBaQ_Yz2XXPx2'
  );
} else {
  console.log('Supabase client already initialized.');
}

// Attach the onclick event to the submit button
document.getElementById('submit').onclick = async function() {
  console.log('Submit button clicked.');

  const email = document.getElementById('email').value.trim();
  const pin = document.getElementById('pin').value;
  const msg = document.getElementById('message');
  const prog = document.getElementById('progress');
  const fill = document.getElementById('fill');

  // Sanity check: Log entered email and PIN length
  console.log('Email:', email, 'PIN length:', pin.length);

  if (!email || !pin || pin.length < 6) {
    msg.textContent = 'Please enter valid email and PIN (6+ characters)';
    msg.style.color = 'red';
    console.log('Validation failed: Invalid email or PIN.');
    return;
  }

  msg.textContent = 'Creating your account...';
  msg.style.color = '#111827';
  prog.style.display = 'block';
  fill.style.width = '40%';

  try {
    console.log('Attempting to sign up the user...');
    const { data, error } = await supabase.auth.signUp({ email, password: pin });
    if (error) throw error;

    console.log('Sign-up successful:', data);

    fill.style.width = '70%';

    console.log('Attempting automatic login...');
    const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({ email, password: pin });
    if (loginError) throw loginError;

    console.log('Login successful:', loginData);

    fill.style.width = '100%';

    // Extract token and redirect to account.html with token in query parameter
    const token = loginData.session.access_token;
    msg.textContent = 'PIN set! Redirecting to your account...';
    msg.style.color = 'green';
    console.log('Redirecting with token:', token);

    location.replace(`/account.html?token=${encodeURIComponent(token)}`);
  } catch (error) {
    msg.textContent = 'Error: ' + error.message;
    msg.style.color = 'red';
    prog.style.display = 'none';
    console.error('Error occurred:', error);
  }
};
</script>
</body>
</html>

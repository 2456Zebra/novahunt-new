<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>NovaHunt.ai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body { font-family: "Inter", system-ui, -apple-system, sans-serif; background: #f9fafb; color: #111827; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .page-root { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; padding: 56px 20px; text-align: center; }
    .brand { font-size: 72px; font-weight: 800; margin: 0 0 8px; line-height: 1; }
    .lead { font-weight: 500; font-size: 28px; color: #4b5563; max-width: 920px; margin: 0 0 18px; }
    .domain-form { width: 100%; max-width: 1080px; display: flex; flex-direction: column; align-items: center; }
    input[type="text"] { width: 100%; max-width: 920px; padding: 28px 26px; font-size: 24px; border: 2px solid #d1d5db; border-radius: 28px; margin-bottom: 10px; outline: none; box-shadow: 0 14px 40px rgba(2,6,23,.06); }
    .hint { margin: 8px 0 16px; color: #6b7280; font-size: 15px; text-align: center; max-width: 860px; }
    .actions-row { display: flex; gap: 16px; align-items: center; justify-content: center; flex-wrap: wrap; margin-top: 8px; }
    .cta { display: inline-flex; align-items: center; justify-content: center; gap: 8px; border-radius: 16px; padding: 16px 36px; font-weight: 800; font-size: 18px; text-decoration: none; cursor: pointer; border: none; background: linear-gradient(180deg, #007bff, #06f); color: #fff; box-shadow: 0 32px 80px rgba(0,102,255,.22), 0 10px 30px rgba(0,102,255,.12); font-family: "Inter", system-ui, -apple-system, sans-serif; }
    .results-wrap { width: 100%; max-width: 920px; margin-top: 22px; text-align: left; }
    .result-card { background: white; border-radius: 16px; padding: 16px 20px; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(15,23,42,.08); display: flex; justify-content: space-between; align-items: center; gap: 12px; }
    .result-main { display: flex; flex-direction: column; gap: 4px; }
    .result-name { font-weight: 600; }
    .result-role { font-size: 14px; color: #6b7280; }
    .result-email { font-family: "Inter", system-ui, -apple-system, sans-serif; font-size: 14px; color: #111827; }
    .secondary-btn { padding: 8px 14px; border-radius: 999px; border: 1px solid #d1d5db; background: #f9fafb; font-size: 13px; font-weight: 600; cursor: pointer; }
    .status-msg { margin-top: 16px; font-size: 14px; color: #6b7280; min-height: 20px; }
    .credits-banner { margin-top: 16px; font-size: 14px; color: #4b5563; }
    .credits-strong { font-weight: 700; }
    @media (max-width: 920px) {
      .domain-form { max-width: 96%; }
      input[type="text"] { max-width: 92%; padding: 22px 18px; font-size: 20px; }
    }
    @media (max-width: 768px) {
      .brand { font-size: 48px; }
      .lead { font-size: 22px; }
      .cta { padding: 12px 20px; font-size: 16px; }
      .result-card { flex-direction: column; align-items: flex-start; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="__next">
    <main class="page-root">
      <h1 class="brand">NovaHunt.ai</h1>
      <p class="lead">Find business emails instantly. Enter a company domain and get professional contacts.</p>
      
      <form class="domain-form" id="searchForm">
        <input id="domainInput" type="text" placeholder="Enter domain, e.g. coca-cola.com" required />
        <div class="hint">Try a domain (e.g. coca-cola.com) to do a quick search.</div>
        <div class="actions-row">
          <button type="submit" class="cta">Take us for a test drive</button>
          <a href="/plans.html" class="cta" id="plansButton">View Plans & Pricing</a>
          <a href="/account.html" class="cta" id="accountButton" style="display:none;">Go to Account</a>
          <a href="/plans.html" class="cta" id="upgradeButton" style="display:none;">Upgrade Plan</a>
        </div>
      </form>

      <div class="credits-banner" id="creditsBanner" style="display:none;"></div>
      <div class="status-msg" id="statusMsg"></div>
      <div class="results-wrap" id="results"></div>
    </main>
  </div>

  <script>
    const client = window.supabase.createClient(
      'https://zusfblqrhqalgywcdvld.supabase.co',
      'sb_publishable_KVGRBPQZKqrhQomdahPBaQ_Yz2XXPx2'
    );

    let currentUser = null;
    let currentMeta = null;

    async function refreshUser() {
      const { data, error } = await client.auth.getUser();
      if (error || !data.user) {
        currentUser = null;
        currentMeta = null;
        document.getElementById('plansButton').style.display = 'inline-flex';
        document.getElementById('accountButton').style.display = 'none';
        document.getElementById('upgradeButton').style.display = 'none';
        document.getElementById('creditsBanner').style.display = 'none';
        return;
      }

      currentUser = data.user;
      currentMeta = currentUser.user_metadata || {};

      const plan = currentMeta.plan || 'Free';
      const searches = currentMeta.searches_remaining ?? (plan === 'Starter' ? 100 : plan === 'Pro' ? 500 : plan === 'Enterprise' ? 2500 : 5);
      const reveals  = currentMeta.reveals_remaining  ?? (plan === 'Starter' ? 50  : plan === 'Pro' ? 250 : plan === 'Enterprise' ? 1500 : 3);

      // Show/hide buttons
      document.getElementById('plansButton').style.display = plan === 'Free' ? 'inline-flex' : 'none';
      document.getElementById('accountButton').style.display = 'inline-flex';
      document.getElementById('upgradeButton').style.display = plan === 'Enterprise' ? 'none' : 'inline-flex';

      // Show credits banner
      const banner = document.getElementById('creditsBanner');
      banner.style.display = 'block';
      banner.innerHTML = `Plan: <span class="credits-strong">${plan}</span> 路 Searches left: <span class="credits-strong">${searches}</span> 路 Reveals left: <span class="credits-strong">${reveals}</span>`;

      // Keep values in memory
      currentMeta.plan = plan;
      currentMeta.searches_remaining = searches;
      currentMeta.reveals_remaining = reveals;
    }

    async function updateCredits(newSearches, newReveals) {
      if (!currentUser) return;
      const { error } = await client.auth.updateUser({
        data: {
          ...currentMeta,
          searches_remaining: newSearches,
          reveals_remaining: newReveals
        }
      });
      if (!error) {
        currentMeta.searches_remaining = newSearches;
        currentMeta.reveals_remaining = newReveals;
        const banner = document.getElementById('creditsBanner');
        banner.innerHTML = `Plan: <span class="credits-strong">${currentMeta.plan}</span> 路 Searches left: <span class="credits-strong">${newSearches}</span> 路 Reveals left: <span class="credits-strong">${newReveals}</span>`;
      }
    }

    function renderResults(emails) {
      const container = document.getElementById('results');
      container.innerHTML = '';

      if (!emails || emails.length === 0) {
        container.innerHTML = '<p>No contacts found for this domain.</p>';
        return;
      }

      emails.forEach((e, index) => {
        const fullEmail = e.value || '';
        const name = [e.first_name, e.last_name].filter(Boolean).join(' ') || 'Unknown';
        const role = e.position || 'No title';

        const masked = fullEmail.replace(/(.{2}).+(@.*)/, '$1*****$2');

        const card = document.createElement('div');
        card.className = 'result-card';

        const main = document.createElement('div');
        main.className = 'result-main';

        const nameEl = document.createElement('div');
        nameEl.className = 'result-name';
        nameEl.textContent = name;

        const roleEl = document.createElement('div');
        roleEl.className = 'result-role';
        roleEl.textContent = role;

        const emailEl = document.createElement('div');
        emailEl.className = 'result-email';
        emailEl.textContent = fullEmail ? masked : 'Email not available';

        main.appendChild(nameEl);
        main.appendChild(roleEl);
        main.appendChild(emailEl);

        const actions = document.createElement('div');

        const revealBtn = document.createElement('button');
        revealBtn.className = 'secondary-btn';
        revealBtn.textContent = 'Reveal email';

        revealBtn.onclick = async () => {
          if (!currentUser) {
            alert('Create an account and log in to reveal emails.');
            return;
          }

          const revealsLeft = currentMeta.reveals_remaining ?? 0;
          if (revealsLeft <= 0) {
            alert('You have no reveals left on your plan.');
            return;
          }

          // Decrement reveals and show full email
          await updateCredits(currentMeta.searches_remaining, revealsLeft - 1);
          emailEl.textContent = fullEmail || 'Email not available';
          revealBtn.disabled = true;
          revealBtn.textContent = 'Revealed';
        };

        actions.appendChild(revealBtn);

        card.appendChild(main);
        card.appendChild(actions);
        container.appendChild(card);
      });
    }

    document.getElementById('searchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const domain = document.getElementById('domainInput').value.trim();
      const status = document.getElementById('statusMsg');
      const results = document.getElementById('results');

      if (!domain) return;

      status.textContent = 'Searching...';
      results.innerHTML = '';

      // If logged in, enforce searches_remaining
      if (currentUser) {
        const searchesLeft = currentMeta.searches_remaining ?? 0;
        if (searchesLeft <= 0) {
          status.textContent = 'You have no searches left on your plan. Please upgrade to continue.';
          return;
        }
        // Decrement searches pre-emptively
        await updateCredits(searchesLeft - 1, currentMeta.reveals_remaining ?? 0);
      }

      try {
        const resp = await fetch(`/api/hunter-search?domain=${encodeURIComponent(domain)}`);
        const data = await resp.json();
        if (!resp.ok) {
          status.textContent = data.error || 'Error searching domain.';
          return;
        }

        const emails = data && data.data && data.data.emails ? data.data.emails : [];
        renderResults(emails);
        status.textContent = emails.length ? `Found ${emails.length} contacts.` : 'No contacts found.';
      } catch (err) {
        console.error(err);
        status.textContent = 'Network error while searching.';
      }
    });

    // On load, detect logged-in state and populate credits
    refreshUser();
  </script>
</body>
</html>

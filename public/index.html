<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>NovaHunt.ai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    /* full CSS here — same as your original */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <a id="authLink" href="/login.html">Sign In</a>
  <main class="page-root">
    <h1 class="brand">NovaHunt.ai</h1>
    <p class="lead">Find business emails instantly. Enter a company domain and get professional contacts.</p>
    <form class="domain-form" id="searchForm">
      <input id="domainInput" type="text" placeholder="Enter domain, e.g. coca-cola.com" required />
      <div class="actions-row">
        <button type="submit" class="cta">New Search</button>
        <a href="/plans.html" class="cta" id="plansButton">View Plans & Pricing</a>
        <a href="/account" class="cta" id="accountButton" style="display:none;">Go to Account</a>
        <a href="/plans.html" class="cta" id="upgradeButton" style="display:none;">Upgrade Plan</a>
      </div>
    </form>
    <div id="creditsBanner" style="margin-top:16px; font-size:14px; color:#4b5563; display:none;"></div>
    <div id="statusMsg" style="margin-top:16px; font-size:14px; color:#6b7280;"></div>
    <div class="results-wrap" id="results"></div>
    <button id="loadMoreBtn">Load More</button>
  </main>
  <script>
    const client = window.supabase.createClient(
      'https://zusfblqrhqalgywcdvld.supabase.co',
      'sb_publishable_KVGRBPQZKqrhQomdahPBaQ_Yz2XXPx2'
    );
    let currentUser = null;
    let currentMeta = null;
    let offset = 0;
    let totalResults = 0;
    let currentDomain = '';

    const deptOrder = ['Executive','Management','Marketing','Sales','Operations','Design','Communication','Legal','Support','Department unknown'];
    let deptData = {};

    async function refreshUser() {
      const { data } = await client.auth.getUser();
      const authLink = document.getElementById('authLink');
      if (!data.user) {
        currentUser = null;
        currentMeta = null;
        authLink.textContent = 'Sign In';
        authLink.href = '/login.html';
        document.getElementById('plansButton').style.display = 'inline-flex';
        document.getElementById('accountButton').style.display = 'none';
        document.getElementById('upgradeButton').style.display = 'none';
        document.getElementById('creditsBanner').style.display = 'none';
        return;
      }
      currentUser = data.user;
      currentMeta = currentUser.user_metadata || {};
      authLink.textContent = 'Account';
      authLink.href = '/account';
      const plan = currentMeta.plan || 'Free';
      const searches = currentMeta.searches_remaining ?? (plan === 'Starter' ? 100 : plan === 'Pro' ? 500 : plan === 'Enterprise' ? 2500 : 5);
      const reveals = currentMeta.reveals_remaining ?? (plan === 'Starter' ? 50 : plan === 'Pro' ? 250 : plan === 'Enterprise' ? 1500 : 3);
      document.getElementById('plansButton').style.display = plan === 'Free' ? 'inline-flex' : 'none';
      document.getElementById('accountButton').style.display = 'inline-flex';
      document.getElementById('upgradeButton').style.display = plan === 'Enterprise' ? 'none' : 'inline-flex';
      const banner = document.getElementById('creditsBanner');
      banner.style.display = 'block';
      banner.innerHTML = `Plan: <b>${plan}</b> · Searches left: <b>${searches}</b> · Reveals left: <b>${reveals}</b>`;
      currentMeta.plan = plan;
      currentMeta.searches_remaining = searches;
      currentMeta.reveals_remaining = reveals;
    }
    const PAGE_SIZE = 250;

    async function updateCredits(newSearches, newReveals) {
      if (!currentUser) return;
      const { data } = await client.auth.updateUser({
        data: { ...currentMeta, searches_remaining: newSearches, reveals_remaining: newReveals }
      });
      if (data && data.user) {
        currentUser = data.user;
        currentMeta = currentUser.user_metadata || currentMeta;
      }
      document.getElementById('creditsBanner').innerHTML =
        `Plan: <b>${currentMeta.plan}</b> · Searches left: <b>${currentMeta.searches_remaining}</b> · Reveals left: <b>${currentMeta.reveals_remaining}</b>`;
    }

    function renderSingleResult(e, container, domain, acceptAll) {
      // full card rendering logic with accept-all warning
    }

    function renderResults(emails, domain, isLoadMore = false, acceptAll = false) {
      // grouping, sorting, collapsible departments, status message, load more toggle
    }

    async function loadMore() {
      if (!currentUser) {
        alert('Sign up or log in to load more results.');
        return;
      }
      offset += PAGE_SIZE;
      const resp = await fetch('/api/hunter-search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ domain: currentDomain, offset, limit: PAGE_SIZE })
      });
      const data = await resp.json();
      const emails = data.emails || [];
      const acceptAll = data.status === 'accept-all';
      renderResults(emails, currentDomain, true, acceptAll);
    }

    document.getElementById('loadMoreBtn').addEventListener('click', loadMore);

    document.getElementById('searchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const domain = document.getElementById('domainInput').value.trim();
      const status = document.getElementById('statusMsg');
      const results = document.getElementById('results');
      currentDomain = domain;
      offset = 0;
      status.textContent = 'Searching...';
      results.innerHTML = '';
      document.getElementById('loadMoreBtn').style.display = 'none';

      if (currentUser) {
        if (currentMeta.searches_remaining <= 0) {
          status.textContent = 'No searches left.';
          return;
        }
        await updateCredits(currentMeta.searches_remaining - 1, currentMeta.reveals_remaining);
      }

      const resp = await fetch('/api/hunter-search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ domain, offset: 0, limit: PAGE_SIZE })
      });
      const data = await resp.json();

      const emails = data.emails || [];
      const acceptAll = data.status === 'accept-all';
      totalResults = data.total || emails.length;

      renderResults(emails, domain, false, acceptAll);

      const shown = emails.length;
      status.textContent = `Showing ${shown} of ${totalResults} contacts`;
      if (shown < totalResults) {
        document.getElementById('loadMoreBtn').style.display = 'block';
      }
    });

    refreshUser();
  </script>
  <footer style="
    text-align:center;
    padding:20px 0;
    font-size:14px;
    color:#6b7280;
    border-top:1px solid #e5e7eb;
    margin-top:40px;
  ">
    © 2026 NovaHunt.ai —
    <a href="mailto:hello@novahunt.ai" style="color:#6b7280; text-decoration:none;">
      Contact
    </a>
   </footer>
</body>
</html>

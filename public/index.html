<!-- RESULTS SECTION -->
<div id="creditsBanner" style="display:none;"></div>
<div id="statusMsg"></div>

<div class="results-wrap" id="results"></div>

<button id="loadMoreBtn"
  style="
    display:none;
    margin: 30px auto;
    padding: 14px 26px;
    border-radius: 14px;
    background: #e5e7eb;
    border: none;
    font-weight: 600;
    cursor: pointer;
    font-size: 15px;
  ">
  Load More
</button>

<!-- FUNCTIONAL JAVASCRIPT (UNCHANGED EXCEPT FOR RESULTS VISIBILITY FIX) -->
<script>
  const HUNTER_API_KEY = "b2eb114113547c1eeb296f358fb10653acc0727a";
  const PAGE_SIZE = 100;

  const client = window.supabase.createClient(
    'https://zusfblqrhqalgywcdvld.supabase.co',
    'sb_publishable_KVGRBPQZKqrhQomdahPBaQ_Yz2XXPx2'
  );

  let currentUser = null;
  let currentMeta = null;
  let offset = 0;
  let totalResults = 0;
  let currentDomain = '';

  const deptOrder = [
    'Executive',
    'Management',
    'Marketing',
    'Sales',
    'Operations',
    'Design',
    'Communication',
    'Legal',
    'Support',
    'Department unknown'
  ];

  async function refreshUser() {
    const { data } = await client.auth.getUser();
    const authLink = document.getElementById('authLink');

    if (!data.user) {
      currentUser = null;
      currentMeta = null;
      authLink.textContent = 'Sign In';
      authLink.href = '/login.html';

      document.getElementById('plansButton').style.display = 'inline-flex';
      document.getElementById('accountButton').style.display = 'none';
      document.getElementById('upgradeButton').style.display = 'none';
      document.getElementById('creditsBanner').style.display = 'none';
      return;
    }

    currentUser = data.user;
    currentMeta = currentUser.user_metadata || {};

    authLink.textContent = 'Account';
    authLink.href = '/account';

    const plan = currentMeta.plan || 'Free';
    const searches = currentMeta.searches_remaining ??
      (plan === 'Starter' ? 100 :
       plan === 'Pro' ? 500 :
       plan === 'Enterprise' ? 2500 : 5);

    const reveals = currentMeta.reveals_remaining ??
      (plan === 'Starter' ? 50 :
       plan === 'Pro' ? 250 :
       plan === 'Enterprise' ? 1500 : 3);

    document.getElementById('plansButton').style.display = plan === 'Free' ? 'inline-flex' : 'none';
    document.getElementById('accountButton').style.display = 'inline-flex';
    document.getElementById('upgradeButton').style.display = plan === 'Enterprise' ? 'none' : 'inline-flex';

    const banner = document.getElementById('creditsBanner');
    banner.style.display = 'block';
    banner.innerHTML = `Plan: <b>${plan}</b> · Searches left: <b>${searches}</b> · Reveals left: <b>${reveals}</b>`;

    currentMeta.plan = plan;
    currentMeta.searches_remaining = searches;
    currentMeta.reveals_remaining = reveals;
  }

  async function updateCredits(newSearches, newReveals) {
    if (!currentUser) return;

    const { data } = await client.auth.updateUser({
      data: { ...currentMeta, searches_remaining: newSearches, reveals_remaining: newReveals }
    });

    if (data && data.user) {
      currentUser = data.user;
      currentMeta = currentUser.user_metadata || currentMeta;
    }

    document.getElementById('creditsBanner').innerHTML =
      `Plan: <b>${currentMeta.plan}</b> · Searches left: <b>${currentMeta.searches_remaining}</b> · Reveals left: <b>${currentMeta.reveals_remaining}</b>`;
  }

  function renderSingleResult(e, container, domain) {
    const fullEmail = e.value || '';
    const name = [e.first_name, e.last_name].filter(Boolean).join(' ') || 'Unknown';
    const role = e.position || 'No title';
    const masked = fullEmail.replace(/(.{2}).+(@.*)/, '$1*****$2');

    const card = document.createElement('div');
    card.className = 'result-card';

    const nameEl = document.createElement('div');
    nameEl.className = 'result-name';
    nameEl.textContent = name;

    const roleEl = document.createElement('div');
    roleEl.className = 'result-role';
    roleEl.textContent = role;

    const confEl = document.createElement('div');
    confEl.className = 'result-role';
    confEl.textContent = `${e.confidence}% confidence`;

    const emailEl = document.createElement('div');
    emailEl.className = 'result-email';
    emailEl.textContent = masked;

    const actions = document.createElement('div');
    actions.style.marginTop = '10px';

    const revealBtn = document.createElement('button');
    revealBtn.className = 'secondary-btn';
    revealBtn.textContent = 'Reveal Email';

    const saveBtn = document.createElement('button');
    saveBtn.className = 'secondary-btn';
    saveBtn.textContent = 'Save Email';
    saveBtn.disabled = true;

    revealBtn.onclick = async () => {
      if (!currentUser) return alert('Log in to reveal emails.');
      if (currentMeta.reveals_remaining <= 0) return alert('No reveals left.');

      await updateCredits(currentMeta.searches_remaining, currentMeta.reveals_remaining - 1);

      emailEl.textContent = fullEmail;
      revealBtn.disabled = true;
      revealBtn.textContent = 'Revealed';
      saveBtn.disabled = false;
    };

    saveBtn.onclick = async () => {
      if (!currentUser) return alert('Log in to save contacts.');
      if (saveBtn.disabled) return;

      const { data } = await client.auth.getUser();
      if (data && data.user) {
        currentUser = data.user;
        currentMeta = currentUser.user_metadata || currentMeta;
      }

      const saved = (currentMeta.saved_contacts || []).slice();
      saved.push({
        email: fullEmail,
        name,
        role,
        domain,
        saved_at: new Date().toISOString()
      });

      const { data: updated } = await client.auth.updateUser({
        data: { ...currentMeta, saved_contacts: saved }
      });

      if (updated && updated.user) {
        currentUser = updated.user;
        currentMeta = updated.user.user_metadata || currentMeta;
      }

      saveBtn.textContent = 'Saved';
      saveBtn.disabled = true;
    };

    const sourceBtn = document.createElement('button');
    sourceBtn.className = 'secondary-btn';
    sourceBtn.textContent = 'Source';
    sourceBtn.onclick = () => {
      if (!currentUser) return alert('Log in to view sources.');
      const q = encodeURIComponent(`${name} ${domain}`);
      window.open(`https://www.google.com/search?q=${q}`, '_blank');
    };

    actions.appendChild(revealBtn);
    actions.appendChild(saveBtn);
    actions.appendChild(sourceBtn);

    card.appendChild(nameEl);
    card.appendChild(roleEl);
    card.appendChild(confEl);
    card.appendChild(emailEl);
    card.appendChild(actions);

    container.appendChild(card);
  }

  function renderResults(emails, domain) {
    const container = document.getElementById('results');
    container.innerHTML = '';

    const groups = {};
    emails.forEach(e => {
      let dept = e.department || 'Department unknown';
      dept = dept.charAt(0).toUpperCase() + dept.slice(1);
      if (!groups[dept]) groups[dept] = [];
      groups[dept].push(e);
    });

    const sortedDepts = Object.keys(groups).sort((a, b) => {
      const indexA = deptOrder.indexOf(a);
      const indexB = deptOrder.indexOf(b);
      if (indexA === -1) return 1;
      if (indexB === -1) return -1;
      return indexA - indexB;
    });

    let first = true;

    sortedDepts.forEach(dept => {
      const deptDiv = document.createElement('div');
      deptDiv.className = 'dept-section';

      const header = document.createElement('div');
      header.className = 'dept-header';
      header.innerHTML = `
        <span class="dept-name">${dept}</span>
        <span class="dept-count">(${groups[dept].length})</span>
        <span class="dept-arrow">${first ? '▲' : '▼'}</span>
      `;

      const content = document.createElement('div');
      content.className = 'dept-content';
      if (first) content.classList.add('open');
      first = false;

      groups[dept].forEach(e => renderSingleResult(e, content, domain));

      header.onclick = () => {
        content.classList.toggle('open');
        const arrow = header.querySelector('.dept-arrow');
        arrow.textContent = content.classList.contains('open') ? '▲' : '▼';
      };

      deptDiv.appendChild(header);
      deptDiv.appendChild(content);
      container.appendChild(deptDiv);
    });

    // ⭐ Show results container now that results exist
    container.style.display = 'block';
  }

  async function loadMore() {
    if (!currentUser) {
      alert('Sign up or log in to load more results.');
      return;
    }

    offset += PAGE_SIZE;

    const resp = await fetch(
      `https://api.hunter.io/v2/domain-search?domain=${encodeURIComponent(currentDomain)}&offset=${offset}&limit=${PAGE_SIZE}&api_key=${HUNTER_API_KEY}`
    );

    const data = await resp.json();
    const emails = data.data?.emails || [];

    renderResults(emails, currentDomain);

    const shown = document.querySelectorAll('.result-card').length;
    document.getElementById('statusMsg').textContent = `Showing ${shown} of ${totalResults} contacts`;

    if (shown >= totalResults || !emails.length) {
      document.getElementById('loadMoreBtn').style.display = 'none';
    }
  }

  document.getElementById('loadMoreBtn').addEventListener('click', loadMore);

  document.getElementById('searchForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const domain = document.getElementById('domainInput').value.trim();
    const status = document.getElementById('statusMsg');
    const results = document.getElementById('results');

    currentDomain = domain;
    offset = 0;

    status.textContent = 'Searching...';

    // ⭐ Hide results container until results exist
    results.innerHTML = '';
    results.style.display = 'none';

    document.getElementById('loadMoreBtn').style.display = 'none';

    if (currentUser) {
      if (currentMeta.searches_remaining <= 0) {
        status.textContent = 'No searches left.';
        return;
      }
      await updateCredits(currentMeta.searches_remaining - 1, currentMeta.reveals_remaining);
    }

    const resp = await fetch(
      `https://api.hunter.io/v2/domain-search?domain=${encodeURIComponent(domain)}&offset=0&limit=${PAGE_SIZE}&api_key=${HUNTER_API_KEY}`
    );

    const data = await resp.json();
    const emails = data.data?.emails || [];

    totalResults = data.meta?.results || emails.length;
    const shown = emails.length;

    status.textContent = `Showing ${shown} of ${totalResults} contacts`;

    renderResults(emails, domain);

    if (shown < totalResults) {
      document.getElementById('loadMoreBtn').style.display = 'block';
    }
  });

  refreshUser();
</script>

<!-- FOOTER -->
<footer style="
  text-align:center;
  padding: 40px 0;
  font-size: 14px;
  color: var(--text-muted);
  margin-top: 60px;
">
  © 2026 NovaHunt.ai —
  <a href="mailto:hello@novahunt.ai" style="color:var(--text-muted); text-decoration:none;">
    Contact
  </a>
</footer>

<!-- AOS JS -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
  AOS.init({
    duration: 900,
    easing: 'ease-out-quart',
    once: true
  });
</script>

<!-- Statcounter -->
<script type="text/javascript">
var sc_project=13194804;
var sc_invisible=1;
var sc_security="d9cb3a26";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="web stats"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/13194804/0/d9cb3a26/1/"
alt="web stats"
referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>

</body>
</html>
